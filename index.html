<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Redefinir senha - LAPAV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonte Google parecida com a do app -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />

  <!-- Supabase JS (CDN) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root {
      /* mesmas cores do app */
      --bg-main: #05090F;        /* fundo preto-azulado */
      --surface: #111827;        /* card */
      --accent: #00d1b2;         /* verde-água / primary */
      --text-primary: #ffffff;
      --text-muted: #9ca3af;
      --error: #f87171;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top left, #111827 0, #05090F 40%, #02040a 100%);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .card {
      background: var(--surface);
      border-radius: 24px;
      max-width: 420px;
      width: 100%;
      padding: 32px 24px 28px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .logo{
	  display: flex;
	  justify-content: center;
	  align-items: center;
	  margin: 0 auto 10px;
	}

    .logo img{
	  width: 150px;
	  max-width: 70%;
	  height: auto;
	  object-fit: contain;
	  display: block;
	}

    h1 {
      text-align: center;
      font-size: 1.4rem;
      margin-bottom: 4px;
    }

    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    label {
      font-size: 0.85rem;
      margin-bottom: 4px;
      display: block;
    }

    .field {
      margin-top: 8px;
      margin-bottom: 6px;
    }

    input[type="password"] {
      width: 100%;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: var(--text-primary);
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    input[type="password"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(0, 209, 178, 0.35);
    }

    .hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .error-message {
      font-size: 0.8rem;
      color: var(--error);
      margin-top: 4px;
      min-height: 1.1em;
    }

    .success-message {
      font-size: 0.85rem;
      color: var(--accent);
      margin-top: 6px;
      text-align: center;
    }

    .btn {
      margin-top: 14px;
      width: 100%;
      padding: 11px 16px;
      border-radius: 999px;
      border: 2px solid #ffffff;
      background: transparent;
      color: #ffffff;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.15s, transform 0.08s, box-shadow 0.15s;
    }

    .btn:hover {
      background: rgba(0, 209, 178, 0.08);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .footer {
      margin-top: 10px;
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .footer a {
      color: var(--accent);
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    .spinner {
      border: 3px solid rgba(156, 163, 175, 0.4);
      border-top-color: var(--accent);
      border-radius: 50%;
      width: 18px;
      height: 18px;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    .btn-content {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="logo">
      <!-- Logo IBMS -->
      <img src="logo_dark.png" alt="Laboratório de Pavimentação" />
    </div>

    <h1>Redefinir senha</h1>
    <p class="subtitle">
      Escolha uma nova senha para acessar o aplicativo.
    </p>

    <div class="field">
      <label for="password">Nova senha</label>
      <input type="password" id="password" autocomplete="new-password" />
      <div class="hint">Use pelo menos 6 caracteres.</div>
    </div>

    <div class="field">
      <label for="confirm_password">Confirmar nova senha</label>
      <input type="password" id="confirm_password" autocomplete="new-password" />
      <div class="hint">Digite a mesma senha novamente.</div>
      <div id="error" class="error-message"></div>
    </div>

    <button id="submitBtn" class="btn">
      <span class="btn-content" id="btnContent">Atualizar senha</span>
    </button>

    <div id="success" class="success-message"></div>

    <div class="footer">
      Em caso de dúvidas, 
      <br />
      <a href="https://www.ufrgs.br/lapav/" target="_blank" rel="noopener">
        visite o site oficial.
      </a>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://svwhgqpjeagdubdorseq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2d2hncXBqZWFnZHViZG9yc2VxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTg3NTAsImV4cCI6MjA4MjA5NDc1MH0.9ixIw95Pr7YO9uwuBmOcCe4WKcgZfeSZfrV4kSxFGgg";

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const passwordInput = document.getElementById("password");
    const confirmInput = document.getElementById("confirm_password");
    const errorBox = document.getElementById("error");
    const successBox = document.getElementById("success");
    const submitBtn = document.getElementById("submitBtn");
    const btnContent = document.getElementById("btnContent");

    function setLoading(isLoading) {
      if (isLoading) {
        btnContent.innerHTML = '<span class="spinner"></span> Salvando...';
        submitBtn.disabled = true;
        submitBtn.style.opacity = "0.7";
      } else {
        btnContent.textContent = "Atualizar senha";
        submitBtn.disabled = false;
        submitBtn.style.opacity = "1";
      }
    }

    function showError(message) {
      errorBox.textContent = message || "";
      successBox.textContent = "";
    }

    function showSuccess(message) {
      successBox.textContent = message || "";
      errorBox.textContent = "";
    }

    // Ao clicar no botão, atualiza a senha do usuário logado (via link de recovery)
    submitBtn.addEventListener("click", async () => {
      const newPassword = passwordInput.value.trim();
      const confirmPassword = confirmInput.value.trim();
      showError("");
      showSuccess("");

      if (!newPassword) {
        showError("Digite uma nova senha.");
        return;
      }

      if (newPassword.length < 6) {
        showError("A senha deve ter pelo menos 6 caracteres.");
        return;
      }

      if (!confirmPassword) {
        showError("Confirme a nova senha.");
        return;
      }

      if (newPassword !== confirmPassword) {
        showError("As senhas não coincidem. Digite a mesma senha nos dois campos.");
        return;
      }

      setLoading(true);

      try {
        // Garante que temos uma sessão válida (o link de recovery já loga o usuário)
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();

        if (sessionError || !session) {
          console.error(sessionError);
          showError("Link inválido ou expirado. Solicite uma nova redefinição de senha.");
          setLoading(false);
          return;
        }

        // Atualiza a senha
        const { error: updateError } = await supabaseClient.auth.updateUser({
          password: newPassword
        });

        if (updateError) {
          console.error(updateError);
          showError("Não foi possível atualizar a senha. Tente novamente.");
        } else {
          showSuccess("Senha atualizada com sucesso! Redirecionando...");
          passwordInput.value = "";
          confirmInput.value = "";

          // Redireciona para a página de sucesso após 1,2s
          setTimeout(() => {
            window.location.href = "success.html";
          }, 1200);
        }
      } catch (err) {
        console.error(err);
        showError("Ocorreu um erro inesperado. Tente novamente mais tarde.");
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
